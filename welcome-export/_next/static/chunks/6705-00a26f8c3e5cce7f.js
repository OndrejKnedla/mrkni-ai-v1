"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6705],{1888:(e,t,o)=>{o.d(t,{A:()=>s,AuthProvider:()=>c});var r=o(8081),n=o(2149),i=o(4134);let a=(0,n.createContext)(void 0);function c(e){let{children:t}=e,[o,c]=(0,n.useState)(null),[s,l]=(0,n.useState)(!0);(0,n.useEffect)(()=>{(async()=>{try{let{data:{session:e}}=await i.N.auth.getSession();c((null==e?void 0:e.user)||null)}catch(e){console.error("Error checking session:",e)}finally{l(!1)}})();let{data:{subscription:e}}=i.N.auth.onAuthStateChange((e,t)=>{c((null==t?void 0:t.user)||null)});return()=>{e.unsubscribe()}},[]);let d=async()=>{try{console.log("Starting Google sign-in process...");let e="".concat(window.location.protocol,"//").concat(window.location.host);console.log("Using base URL for redirect: ".concat(e));let{data:t,error:o}=await i.N.auth.signInWithOAuth({provider:"google",options:{redirectTo:"".concat(e,"/auth/callback"),queryParams:{access_type:"offline",prompt:"consent"},scopes:"email profile"}});if(o)throw console.error("Google sign-in error:",o),o;console.log("Sign in initiated successfully, redirecting to Google",t)}catch(e){throw console.error("Error in signInWithGoogle:",e),e}},g=async(e,t)=>{let{error:o}=await i.N.auth.signInWithPassword({email:e,password:t});if(o)throw o},u=async(e,t)=>{let{error:o}=await i.N.auth.signUp({email:e,password:t});if(o)throw o},m=async()=>{let{error:e}=await i.N.auth.signOut();if(e)throw e};return(0,r.jsx)(a.Provider,{value:{user:o,loading:s,signInWithGoogle:d,signIn:g,signUp:u,signOut:m},children:t})}let s=()=>{let e=(0,n.useContext)(a);if(!e)throw Error("useAuth must be used within an AuthProvider");return e}},2716:(e,t,o)=>{o.d(t,{HistoryProvider:()=>h,W:()=>f});var r=o(8081),n=o(2149),i=o(4134),a=o(7553);async function c(e,t){let{data:{user:o}}=await i.N.auth.getUser();if(!o)throw Error("User not authenticated to save generation.");if(console.log("Attempting to save/update ".concat(t.toUpperCase()," generation with ID: ").concat(e.id)),"image"===t){let{data:t,error:r}=await i.N.from("image_generations").upsert({id:e.id,user_id:o.id,prompt:e.input.prompt,negative_prompt:e.input.negative_prompt||null,width:e.input.width,height:e.input.height,steps:e.input.num_inference_steps,guidance_scale:e.input.guidance_scale,scheduler:e.input.scheduler,seed:e.input.seed||null,model:e.input.model||"unknown",created_at:e.created_at,status:e.status,error:e.error||null},{onConflict:"id"}).select().single();if(r)throw console.error("Error upserting image generation record:",r),r;if(console.log("Upserted image generation record:",t.id),"succeeded"===e.status&&Array.isArray(e.output)&&e.output.length>0){console.log("Deleting existing associated images before upsert for generation ID: ".concat(t.id));let{error:o}=await i.N.from("generated_images").delete().eq("generation_id",t.id);if(o)throw console.error("Error deleting existing images for ".concat(t.id,":"),o),Error("Failed to clear existing images before upsert: ".concat(o.message));let r=e.output.map(e=>({generation_id:t.id,image_url:e}));console.log("Attempting to insert ".concat(r.length," associated images for generation ID: ").concat(t.id));let{error:n}=await i.N.from("generated_images").insert(r);if(n)throw console.error("Error inserting generated images for ".concat(t.id,":"),n),Error("Failed to insert associated images: ".concat(n.message));console.log("Successfully inserted associated images for generation ID: ".concat(t.id))}else{console.log("No output images found or status not succeeded for generation ID: ".concat(t.id)),console.log("Deleting any potentially orphaned associated images for generation ID: ".concat(t.id));let{error:e}=await i.N.from("generated_images").delete().eq("generation_id",t.id);e&&console.error("Error deleting orphaned images for ".concat(t.id,":"),e)}return t}if("video"===t){let{data:t,error:r}=await i.N.from("video_generations").upsert({replicate_id:e.id,user_id:o.id,prompt:e.input.prompt,negative_prompt:e.input.negative_prompt||null,width:e.input.width,height:e.input.height,num_frames:e.input.num_frames,fps:e.input.fps,seed:e.input.seed||null,status:e.status||"processing",model_id:e.input.model||"unknown",created_at:e.created_at,output_url:Array.isArray(e.output)?e.output[0]:"string"==typeof e.output?e.output:null,error:e.error||null},{onConflict:"replicate_id"}).select().single();if(r)throw console.error("Error upserting video generation record:",r),r;return console.log("Upserted video generation record:",t.replicate_id),t}throw console.error("Invalid type provided to saveGeneration:",t),Error("Invalid generation type specified.")}async function s(){try{let{data:{user:e}}=await i.N.auth.getUser();if(!e)return console.log("No user found, returning empty history."),[];console.log("Fetching IMAGE and VIDEO generation history for user:",e.id);let t=[];try{let{data:o,error:r}=await i.N.from("image_generations").select("*, generated_images(*)").eq("user_id",e.id).order("created_at",{ascending:!1});r?console.error("Error fetching image generations (with join):",r):o&&(console.log("Fetched ".concat(o.length," raw image generation records (with join).")),t=o.map(d))}catch(e){console.error("Exception fetching image generations:",e)}let o=[];try{let{data:t,error:r}=await i.N.from("video_generations").select("*").eq("user_id",e.id).order("created_at",{ascending:!1});r?console.error("Error fetching video generations:",r):t&&(console.log("Fetched ".concat(t.length," raw video generation records.")),console.log("Raw videoGenerationsData:",JSON.stringify(t,null,2)),o=t.map(g))}catch(e){console.error("Exception fetching video generations:",e)}let r=[...t,...o];return r.sort((e,t)=>new Date(t.created_at).getTime()-new Date(e.created_at).getTime()),console.log("Combined history count: ".concat(r.length)),r}catch(e){return console.error("Error in getGenerationHistory:",e),[]}}async function l(e,t){if(console.log("Attempting to delete ".concat(t," generation with ID: ").concat(e)),"image"===t){let t="image_generations",o="generated_images";console.log("Deleting associated records from ".concat(o," for ID: ").concat(e));let{error:r}=await i.N.from(o).delete().eq("generation_id",e);r?console.error("Error deleting associated records from ".concat(o,":"),r):console.log("Successfully deleted associated records from ".concat(o," for ID: ").concat(e)),console.log("Deleting main record from ".concat(t," with ID: ").concat(e));let{error:n}=await i.N.from(t).delete().eq("id",e);if(n)throw console.error("Error deleting main record ".concat(e," from ").concat(t,":"),n),n;console.log("Successfully deleted main record with ID: ".concat(e," from ").concat(t))}else if("video"===t){let t="video_generations";console.log("Deleting main record from ".concat(t," with replicate_id: ").concat(e));let{error:o}=await i.N.from(t).delete().eq("replicate_id",e);if(o)throw console.error("Error deleting main record ".concat(e," from ").concat(t,":"),o),o;console.log("Successfully deleted main record with replicate_id: ".concat(e," from ").concat(t))}else throw console.error("Invalid type provided to deleteGeneration:",t),Error("Invalid generation type specified.")}function d(e){console.log("[convertToImageHistoryItem] Processing generation ID: ".concat(e.id));try{console.log("[convertToImageHistoryItem] Raw generated_images for ".concat(e.id,":"),JSON.stringify(e.generated_images,null,2));let t=Array.isArray(e.generated_images)?e.generated_images:[];console.log("[convertToImageHistoryItem] imagesArray length for ".concat(e.id,": ").concat(t.length));let o=t.filter(t=>{let o=t&&t.image_url&&"string"==typeof t.image_url&&""!==t.image_url.trim();return o||console.log("[convertToImageHistoryItem] Filtering out invalid image data for ".concat(e.id,":"),t),o});console.log("[convertToImageHistoryItem] validImagesArray length for ".concat(e.id,": ").concat(o.length));let r=o.length>0?o.map(e=>(0,a.pi)(e.image_url)).filter(e=>e):null,n=r&&r.length>0?r:null;return console.log("[convertToImageHistoryItem] Final historyItemOutput for ".concat(e.id,":"),n),{id:e.id,status:e.status||"succeeded",input:{prompt:e.prompt,negative_prompt:e.negative_prompt||void 0,width:e.width,height:e.height,num_inference_steps:e.steps,guidance_scale:e.guidance_scale,num_images:o.length,scheduler:e.scheduler,seed:e.seed||void 0,model:e.model||"unknown"},output:n,created_at:e.created_at,model:e.model||"Unknown Image Model",type:"image",error:e.error||void 0}}catch(t){return console.error("Error during convertToImageHistoryItem:",t,"Record:",e),{id:(null==e?void 0:e.id)||"error-img-".concat(Date.now()),status:"failed",input:{prompt:"Error: Conversion failed",width:0,height:0,num_inference_steps:0,guidance_scale:0,num_images:0,scheduler:"",model:"unknown"},output:null,created_at:(null==e?void 0:e.created_at)||new Date().toISOString(),error:"Conversion failed: ".concat(t instanceof Error?t.message:String(t)),type:"image"}}}function g(e){try{let t=e.output_url&&"string"==typeof e.output_url&&""!==e.output_url.trim()?e.output_url:null;return{id:e.replicate_id,status:e.status||"processing",input:{prompt:e.prompt,negative_prompt:e.negative_prompt||void 0,width:e.width,height:e.height,num_inference_steps:0,guidance_scale:0,num_images:1,scheduler:"",seed:e.seed||void 0,model:e.model_id||"unknown",num_frames:e.num_frames||void 0,fps:e.fps||void 0},output:t?[t]:null,created_at:e.created_at,model:e.model_id||"Unknown Video Model",type:"video",error:e.error||void 0}}catch(t){return console.error("Error during convertVideoToHistoryItem:",t,"Record:",e),{id:(null==e?void 0:e.replicate_id)||"error-vid-".concat(Date.now()),status:"failed",input:{prompt:"Error: Conversion failed",width:0,height:0,num_inference_steps:0,guidance_scale:0,num_images:0,scheduler:"",model:"unknown"},output:null,created_at:(null==e?void 0:e.created_at)||new Date().toISOString(),error:"Conversion failed: ".concat(t instanceof Error?t.message:String(t)),type:"video"}}}var u=o(1888);function m(e){return e&&Array.isArray(e)?e.map(e=>{if(!e||!e.output||!Array.isArray(e.output))return e;let t=e.output.map(e=>e?(0,a.pi)(e):e);return{...e,output:t}}):e}let p=(0,n.createContext)(void 0);function h(e){let{children:t}=e,{user:o}=(0,u.A)(),[i,a]=(0,n.useState)([]),[d,g]=(0,n.useState)(!0),h=()=>{try{let e=localStorage.getItem("mrkniai-history-"+((null==o?void 0:o.id)||"anonymous"));if(e){let t=JSON.parse(e);console.log("Loaded ".concat(t.length," history items from localStorage"));let o=m(t);return o.length!==t.length&&console.log("Fixed history items count changed from ".concat(t.length," to ").concat(o.length)),o}}catch(e){console.error("Error loading history from localStorage:",e)}return[]},f=e=>{try{localStorage.setItem("mrkniai-history-"+((null==o?void 0:o.id)||"anonymous"),JSON.stringify(e)),console.log("Saved ".concat(e.length," history items to localStorage"))}catch(e){console.error("Error saving history to localStorage:",e)}},y=async()=>{if(!o){a([]),g(!1);return}let e=h();e.length>0&&(console.log("Using ".concat(e.length," items from localStorage while fetching from database")),a(e));try{g(!0);let e=await s();if(console.log("[HistoryContext] Fetched items from getGenerationHistory:",JSON.stringify(e,null,2)),e.length>0){var t,r;console.log("[HistoryContext] Latest fetched item (".concat(null===(t=e[0])||void 0===t?void 0:t.id,") output:"),null===(r=e[0])||void 0===r?void 0:r.output)}else console.log("[HistoryContext] Fetched 0 items.");console.log("Fetched ".concat(e.length," history items from database (combined)"));let o=new Map;e.forEach(e=>{e&&e.id?o.set(e.id,e):console.warn("Fetched history item missing id:",e)});let n=Array.from(o.values()).sort((e,t)=>new Date(t.created_at).getTime()-new Date(e.created_at).getTime());console.log("Processed ".concat(e.length," items into ").concat(n.length," unique items")),a(n),f(n)}catch(t){console.error("Error fetching history:",t),e.length>0&&(console.log("Using ".concat(e.length," items from localStorage as fallback")),a(e))}finally{g(!1)}};(0,n.useEffect)(()=>{(function(){let e=()=>{try{Object.keys(localStorage).filter(e=>e.startsWith("mrkniai-history")).forEach(e=>{try{let t=localStorage.getItem(e);if(!t)return;let o=JSON.parse(t);if(!Array.isArray(o))return;let r=m(o);localStorage.setItem(e,JSON.stringify(r)),console.log("Fixed URLs in localStorage key: ".concat(e))}catch(t){console.error("Error processing localStorage key ".concat(e,":"),t)}})}catch(e){console.error("Error checking localStorage:",e)}};e(),setInterval(e,3e5)})(),console.log("Started periodic image URL checker")},[]),(0,n.useEffect)(()=>{y()},[o]);let v=async(e,t)=>{console.log("addToHistory called for ".concat(t," item ID:"),e.id);try{if(o)await c(e,t),a(t=>{let o=new Map;t.forEach(e=>{e&&e.id&&o.set(e.id,e)}),e&&e.id&&(o.has(e.id)&&console.log("Item ".concat(e.id," already exists in history, updating")),o.set(e.id,e));let r=Array.from(o.values()).sort((e,t)=>new Date(t.created_at).getTime()-new Date(e.created_at).getTime());return f(r),r});else{console.log("Adding item to localStorage history:",e.id);let t=localStorage.getItem("mrkniai-history-anonymous"),o=t?JSON.parse(t):[],r=new Map;o.forEach(e=>{e&&e.id&&r.set(e.id,e)}),e&&e.id&&r.set(e.id,e);let n=Array.from(r.values()).sort((e,t)=>new Date(t.created_at).getTime()-new Date(e.created_at).getTime());localStorage.setItem("mrkniai-history-anonymous",JSON.stringify(n)),a(n)}}catch(e){console.error("Error adding to history:",e)}},_=async()=>{console.warn("clearHistory called - iterating and deleting individually by type");try{if(o){for(let e of i)e.type?await l(e.id,e.type):(console.warn("History item ".concat(e.id," missing type, attempting delete as image")),await l(e.id,"image"));a([]),localStorage.removeItem("mrkniai-history-"+o.id)}else localStorage.removeItem("mrkniai-history-anonymous"),a([])}catch(e){console.error("Error clearing history:",e)}},w=async(e,t)=>{console.log("removeFromHistory called for ".concat(t," item ID:"),e);try{if(!i.find(o=>o.id===e&&o.type===t)){console.warn("Item ".concat(e," of type ").concat(t," not found in history, cannot remove"));let o=i.find(t=>t.id===e);if(!o)return;console.warn("Found item ".concat(e," but with different type (").concat(o.type,"), proceeding with removal using provided type ").concat(t))}if(o){await l(e,t);let o=i.filter(t=>t.id!==e);a(o),f(o)}else{let t=localStorage.getItem("mrkniai-history-anonymous"),o=(t?JSON.parse(t):[]).filter(t=>t.id!==e);localStorage.setItem("mrkniai-history-anonymous",JSON.stringify(o)),a(i.filter(t=>t.id!==e))}}catch(e){console.error("Error removing from history:",e)}},I=async()=>{await y()};return(0,r.jsx)(p.Provider,{value:{history:i,loading:d,addToHistory:v,clearHistory:_,removeFromHistory:w,refreshHistory:I},children:t})}let f=()=>{let e=(0,n.useContext)(p);if(!e)throw Error("useHistory must be used within a HistoryProvider");return e}},4134:(e,t,o)=>{o.d(t,{N:()=>r});let r=(0,o(5331).createBrowserClient)("https://akqpnxofeitmzittndll.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFrcXBueG9mZWl0bXppdHRuZGxsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQxMzcxMjYsImV4cCI6MjA1OTcxMzEyNn0.vVH5D_odlSVOCOZ3BHfkxbDvhuOd_S3e05bQHqUR_pc",{})},5160:(e,t,o)=>{o.d(t,{$:()=>l});var r=o(8081),n=o(2149),i=o(244),a=o(3484),c=o(7687);let s=(0,a.F)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),l=n.forwardRef((e,t)=>{let{className:o,variant:n,size:a,asChild:l=!1,...d}=e,g=l?i.DX:"button";return(0,r.jsx)(g,{className:(0,c.cn)(s({variant:n,size:a,className:o})),ref:t,...d})});l.displayName="Button"},7553:(e,t,o)=>{function r(e){if(!e)return e;let t=e.trim(),o=t.includes("supabase.co/storage/v1/object/public");if(o&&!t.startsWith("http")&&(console.log("Adding https:// prefix to Supabase URL: ".concat(t)),t="https://".concat(t)),o&&!t.includes("?")){let e=Date.now();console.log("Adding cache-busting parameter to URL: ".concat(t)),t="".concat(t,"?t=").concat(e)}return t}function n(e){return!!e&&(e.startsWith("http://")||e.startsWith("https://")||e.startsWith("/")||e.startsWith("data:"))}function i(e){return!!e&&e.includes("supabase.co/storage/v1/object/public")}function a(e){if(!e)return e;let t=e.includes("?")?"&":"?";return"".concat(e).concat(t,"t=").concat(Date.now())}o.d(t,{Pr:()=>i,VP:()=>n,pi:()=>r,zq:()=>a})},7687:(e,t,o)=>{o.d(t,{cn:()=>i});var r=o(6522),n=o(4483);function i(){for(var e=arguments.length,t=Array(e),o=0;o<e;o++)t[o]=arguments[o];return(0,n.QP)((0,r.$)(t))}}}]);